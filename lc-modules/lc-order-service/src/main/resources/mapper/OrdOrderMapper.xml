<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhkj.lc.order.mapper.OrdOrderMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.zhkj.lc.order.model.entity.OrdOrder">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="upstreamId"    column="upstream_id"    />
        <result property="type"    column="type"    />
        <result property="status"    column="status"    />
        <result property="classDate"    column="class_date"    />
        <result property="sendTruckDate"    column="send_truck_date"    />
        <result property="salesman"    column="salesman"    />
        <result property="scheduleman"    column="scheduleman"    />
        <result property="carrier"    column="carrier"    />
        <result property="classOrder"    column="class_order"    />
        <result property="customerId"    column="customer_id"    />
        <result property="productName"    column="product_name"    />
        <result property="size"    column="size"    />
        <result property="weight"    column="weight"    />
        <result property="containerNo"    column="container_no"    />
        <result property="sealNumber"    column="seal_number"    />
        <result property="containerType"    column="container_type"    />
        <result property="containerNum"    column="container_num"    />
        <result property="pickupConPlace"    column="pickup_con_place"    />
        <result property="pickupConDetailplace"    column="pickup_con_detailplace"    />
        <result property="returnConPlace"    column="return_con_place"    />
        <result property="returnConDetailplace"    column="return_con_detailplace"    />
        <result property="consignor"    column="consignor"    />
        <result property="consignorPhone"    column="consignor_phone"    />
        <result property="pickupGoodsPlace"    column="pickup_goods_place"    />
        <result property="pickupGoodsDetailplace"    column="pickup_goods_detailplace"    />
        <result property="pickupGoodsDate"    column="pickup_goods_date"    />
        <result property="consignee"    column="consignee"    />
        <result property="consigneePhone"    column="consignee_phone"    />
        <result property="sendGoodsPlace"    column="send_goods_place"    />
        <result property="sendGoodsDetailplace"    column="send_goods_detailplace"    />
        <result property="sendGoodsDate"    column="send_goods_date"    />
        <result property="driverId"    column="driver_id"    />
        <result property="plateNumber"    column="plate_number"    />
        <result property="isInvoice"    column="is_invoice"    />
        <result property="kilometre"    column="kilometre"    />
        <result property="kmYf"    column="km_yf"    />
        <result property="recPrice" column="rec_price" />
        <result property="payPrice" column="pay_price" />
        <result property="receivables" column="receivables" />
        <result property="needPay" column="need_pay" />
        <result property="payRate" column="pay_rate" />
        <result property="pickcnFee" column="pickcn_fee" />
        <result property="parkingFee" column="parking_fee" />
        <result property="settlement" column="settlement" />
        <result property="receiptCode"    column="receipt_code"    />
        <result property="isSend"    column="is_send"    />
        <result property="remark"    column="remark"    />
        <result property="receiverRemark"    column="receiver_remark"    />
        <result property="upstreamRemark"    column="upstream_remark"    />
        <result property="upstreamIsZqzh"    column="upstream_is_zqzh"    />
        <result property="upstreamZqzhClassOrder"    column="upstream_zqzh_class_order"    />
        <result property="upstreamReportFee"    column="upstream_report_fee"    />
        <result property="upstreamReportRemark"    column="upstream_report_remark"    />
        <result property="upstreamReturnFee"    column="upstream_return_fee"    />
        <result property="upstreamYcDay"    column="upstream_yc_day"    />
        <result property="upstreamYcPrice"    column="upstream_yc_price"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="needPayStatus"    column="need_pay_status"    />
        <result property="tenantId"    column="tenant_id"    />
        <association property="ordOrderFile" javaType="OrdOrderFile" column="order_id" select="com.zhkj.lc.order.mapper.OrdOrderFileMapper.selectOrderFileById"/>
        <collection property="ordOrderLogistics" column="order_id" select="com.zhkj.lc.order.mapper.OrdOrderLogisticsMapper.selectOrderLogisticsList"/>
        <collection property="ordExceptionFees" column="order_id" select="com.zhkj.lc.order.mapper.OrdExceptionFeeMapper.selectExFee"/>
        <collection property="ordExceptionConditions" column="order_id" select="com.zhkj.lc.order.mapper.OrdExceptionConditionMapper.selectExCondition"/>
        <collection property="arrivalAdds" column="order_id" select="com.zhkj.lc.order.mapper.OrdPickupArrivalAddMapper.selectArrivalByOrderId"/>
        <collection property="pickupAdds" column="order_id" select="com.zhkj.lc.order.mapper.OrdPickupArrivalAddMapper.selectPickupByOrderId"/>
    </resultMap>
    <resultMap id="BaseResultMap2" type="com.zhkj.lc.order.dto.OrdOrderVo">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="upstreamId"    column="upstream_id"    />
        <result property="type"    column="type"    />
        <result property="status"    column="status"    />
        <result property="classDate"    column="class_date"    />
        <result property="sendTruckDate"    column="send_truck_date"    />
        <result property="salesman"    column="salesman"    />
        <result property="scheduleman"    column="scheduleman"    />
        <result property="carrier"    column="carrier"    />
        <result property="classOrder"    column="class_order"    />
        <result property="customerId"    column="customer_id"    />
        <result property="productName"    column="product_name"    />
        <result property="size"    column="size"    />
        <result property="weight"    column="weight"    />
        <result property="containerNo"    column="container_no"    />
        <result property="sealNumber"    column="seal_number"    />
        <result property="containerType"    column="container_type"    />
        <result property="containerNum"    column="container_num"    />
        <result property="pickupConPlace"    column="pickup_con_place"    />
        <result property="pickupConDetailplace"    column="pickup_con_detailplace"    />
        <result property="returnConPlace"    column="return_con_place"    />
        <result property="returnConDetailplace"    column="return_con_detailplace"    />
        <result property="consignor"    column="consignor"    />
        <result property="consignorPhone"    column="consignor_phone"    />
        <result property="pickupGoodsPlace"    column="pickup_goods_place"    />
        <result property="pickupGoodsDetailplace"    column="pickup_goods_detailplace"    />
        <result property="pickupGoodsDate"    column="pickup_goods_date"    />
        <result property="consignee"    column="consignee"    />
        <result property="consigneePhone"    column="consignee_phone"    />
        <result property="sendGoodsPlace"    column="send_goods_place"    />
        <result property="sendGoodsDetailplace"    column="send_goods_detailplace"    />
        <result property="sendGoodsDate"    column="send_goods_date"    />
        <result property="driverId"    column="driver_id"    />
        <result property="plateNumber"    column="plate_number"    />
        <result property="isInvoice"    column="is_invoice"    />
        <result property="kilometre"    column="kilometre"    />
        <result property="kmYf"    column="km_yf"    />
        <result property="recPrice" column="rec_price" />
        <result property="payPrice" column="pay_price" />
        <result property="receivables" column="receivables" />
        <result property="needPay" column="need_pay" />
        <result property="payRate" column="pay_rate" />
        <result property="pickcnFee" column="pickcn_fee" />
        <result property="parkingFee" column="parking_fee" />
        <result property="settlement" column="settlement" />
        <result property="receiptCode"    column="receipt_code"    />
        <result property="isSend"    column="is_send"    />
        <result property="remark"    column="remark"    />
        <result property="receiverRemark"    column="receiver_remark"    />
        <result property="upstreamRemark"    column="upstream_remark"    />
        <result property="upstreamIsZqzh"    column="upstream_is_zqzh"    />
        <result property="upstreamZqzhClassOrder"    column="upstream_zqzh_class_order"    />
        <result property="upstreamReportFee"    column="upstream_report_fee"    />
        <result property="upstreamReportRemark"    column="upstream_report_remark"    />
        <result property="upstreamReturnFee"    column="upstream_return_fee"    />
        <result property="upstreamYcDay"    column="upstream_yc_day"    />
        <result property="upstreamYcPrice"    column="upstream_yc_price"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="needPayStatus"    column="need_pay_status"    />
        <result property="tenantId"    column="tenant_id"    />
        <association property="ordOrderFile" javaType="OrdOrderFile" column="order_id" select="com.zhkj.lc.order.mapper.OrdOrderFileMapper.selectOrderFileById"/>
        <collection property="ordOrderLogistics" column="order_id" select="com.zhkj.lc.order.mapper.OrdOrderLogisticsMapper.selectOrderLogisticsList"/>
        <collection property="ordExceptionFees" column="order_id" select="com.zhkj.lc.order.mapper.OrdExceptionFeeMapper.selectExFee"/>
        <collection property="ordExceptionConditions" column="order_id" select="com.zhkj.lc.order.mapper.OrdExceptionConditionMapper.selectExCondition"/>
        <collection property="arrivalAdds" column="order_id" select="com.zhkj.lc.order.mapper.OrdPickupArrivalAddMapper.selectArrivalByOrderId"/>
        <collection property="pickupAdds" column="order_id" select="com.zhkj.lc.order.mapper.OrdPickupArrivalAddMapper.selectPickupByOrderId"/>
         </resultMap>
    <resultMap id="BaseColumnMap" type="com.zhkj.lc.order.model.entity.OrdOrder">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="upstreamId"    column="upstream_id"    />
        <result property="type"    column="type"    />
        <result property="status"    column="status"    />
        <result property="classDate"    column="class_date"    />
        <result property="sendTruckDate"    column="send_truck_date"    />
        <result property="salesman"    column="salesman"    />
        <result property="scheduleman"    column="scheduleman"    />
        <result property="carrier"    column="carrier"    />
        <result property="classOrder"    column="class_order"    />
        <result property="customerId"    column="customer_id"    />
        <result property="productName"    column="product_name"    />
        <result property="size"    column="size"    />
        <result property="weight"    column="weight"    />
        <result property="containerNo"    column="container_no"    />
        <result property="containerType"    column="container_type"    />
        <result property="containerNum"    column="container_num"    />
        <result property="pickupConPlace"    column="pickup_con_place"    />
        <result property="pickupConDetailplace"    column="pickup_con_detailplace"    />
        <result property="returnConPlace"    column="return_con_place"    />
        <result property="returnConDetailplace"    column="return_con_detailplace"    />
        <result property="consignor"    column="consignor"    />
        <result property="consignorPhone"    column="consignor_phone"    />
        <result property="pickupGoodsPlace"    column="pickup_goods_place"    />
        <result property="pickupGoodsDetailplace"    column="pickup_goods_detailplace"    />
        <result property="pickupGoodsDate"    column="pickup_goods_date"    />
        <result property="consignee"    column="consignee"    />
        <result property="consigneePhone"    column="consignee_phone"    />
        <result property="sendGoodsPlace"    column="send_goods_place"    />
        <result property="sendGoodsDetailplace"    column="send_goods_detailplace"    />
        <result property="sendGoodsDate"    column="send_goods_date"    />
        <result property="driverId"    column="driver_id"    />
        <result property="plateNumber"    column="plate_number"    />
        <result property="isInvoice"    column="is_invoice"    />
        <result property="kilometre"    column="kilometre"    />
        <result property="kmYf"    column="km_yf"    />
        <result property="recPrice" column="rec_price" />
        <result property="payPrice" column="pay_price" />
        <result property="payRate" column="pay_rate" />
        <result property="receivables" column="receivables" />
        <result property="needPay" column="need_pay" />
        <result property="pickcnFee" column="pickcn_fee" />
        <result property="parkingFee" column="parking_fee" />
        <result property="settlement" column="settlement" />
        <result property="receiptCode"    column="receipt_code"    />
        <result property="isSend"    column="is_send"    />
        <result property="ifAddToYfbill"    column="if_add_to_yfbill"    />
        <result property="remark"    column="remark"    />
        <result property="receiverRemark"    column="receiver_remark"    />
        <result property="upstreamRemark"    column="upstream_remark"    />
        <result property="upstreamIsZqzh"    column="upstream_is_zqzh"    />
        <result property="upstreamZqzhClassOrder"    column="upstream_zqzh_class_order"    />
        <result property="upstreamReportFee"    column="upstream_report_fee"    />
        <result property="upstreamReportRemark"    column="upstream_report_remark"    />
        <result property="upstreamReturnFee"    column="upstream_return_fee"    />
        <result property="upstreamYcDay"    column="upstream_yc_day"    />
        <result property="upstreamYcPrice"    column="upstream_yc_price"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="tenantId"    column="tenant_id"    />
        <result property="needPayStatus"    column="need_pay_status"    />
    </resultMap>
    <!-- 通用查询映射结果 -->
    <resultMap id="OrderStatusAndPlateNumber" type="com.zhkj.lc.order.model.entity.OrdOrder">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="upstreamId"    column="upstream_id"    />
        <result property="status"    column="status"    />
        <result property="plateNumber"    column="plate_number"    />
        <result property="driverId"    column="driver_id"    />
    </resultMap>

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMapForApp" type="com.zhkj.lc.order.dto.OrdOrderForApp">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="upstreamId"    column="upstream_id"    />
        <result property="type"    column="type"    />
        <result property="status"    column="status"    />
        <result property="classDate"    column="class_date"    />
        <result property="sendTruckDate"    column="send_truck_date"    />
        <result property="salesman"    column="salesman"    />
        <result property="scheduleman"    column="scheduleman"    />
        <result property="carrier"    column="carrier"    />
        <result property="classOrder"    column="class_order"    />
        <result property="customerId"    column="customer_id"    />
        <result property="productName"    column="product_name"    />
        <result property="size"    column="size"    />
        <result property="weight"    column="weight"    />
        <result property="containerNo"    column="container_no"    />
        <result property="sealNumber"    column="seal_number"    />
        <result property="containerType"    column="container_type"    />
        <result property="containerNum"    column="container_num"    />
        <result property="pickupConPlace"    column="pickup_con_place"    />
        <result property="pickupConDetailplace"    column="pickup_con_detailplace"    />
        <result property="returnConPlace"    column="return_con_place"    />
        <result property="returnConDetailplace"    column="return_con_detailplace"    />
        <result property="consignor"    column="consignor"    />
        <result property="consignorPhone"    column="consignor_phone"    />
        <result property="pickupGoodsPlace"    column="pickup_goods_place"    />
        <result property="pickupGoodsDetailplace"    column="pickup_goods_detailplace"    />
        <result property="pickupGoodsDate"    column="pickup_goods_date"    />
        <result property="consignee"    column="consignee"    />
        <result property="consigneePhone"    column="consignee_phone"    />
        <result property="sendGoodsPlace"    column="send_goods_place"    />
        <result property="sendGoodsDetailplace"    column="send_goods_detailplace"    />
        <result property="sendGoodsDate"    column="send_goods_date"    />
        <result property="driverId"    column="driver_id"    />
        <result property="plateNumber"    column="plate_number"    />
        <result property="isInvoice"    column="is_invoice"    />
        <result property="kilometre"    column="kilometre"    />
        <result property="kmYf"    column="km_yf"    />
        <result property="recPrice" column="rec_price" />
        <result property="payPrice" column="pay_price" />
        <result property="receivables" column="receivables" />
        <result property="needPay" column="need_pay" />
        <result property="payRate" column="pay_rate" />
        <result property="pickcnFee" column="pickcn_fee" />
        <result property="parkingFee" column="parking_fee" />
        <result property="settlement" column="settlement" />
        <result property="receiptCode"    column="receipt_code"    />
        <result property="isSend"    column="is_send"    />
        <result property="remark"    column="remark"    />
        <result property="receiver_remark"    column="receiverRemark"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="tenantId"    column="tenant_id"    />
        <association property="ordOrderFile" javaType="OrdOrderFile" column="order_id" select="com.zhkj.lc.order.mapper.OrdOrderFileMapper.selectOrderFileById"/>
        <collection property="ordOrderLogistics" column="order_id" select="com.zhkj.lc.order.mapper.OrdOrderLogisticsMapper.selectOrderLogisticsList"/>
        <collection property="ordExceptionFees" column="order_id" select="com.zhkj.lc.order.mapper.OrdExceptionFeeMapper.selectExFee"/>
        <collection property="ordExceptionConditions" column="order_id" select="com.zhkj.lc.order.mapper.OrdExceptionConditionMapper.selectExCondition"/>
        <collection property="arrivalAdds" column="order_id" select="com.zhkj.lc.order.mapper.OrdPickupArrivalAddMapper.selectArrivalByOrderId"/>
        <collection property="pickupAdds" column="order_id" select="com.zhkj.lc.order.mapper.OrdPickupArrivalAddMapper.selectPickupByOrderId"/>
    </resultMap>

    <!-- 在途订单运踪记录的最新位置 -->
    <resultMap id="ordOrderLogisticsVo" type="com.zhkj.lc.order.model.entity.OrdOrderLogisticsVo">
        <result column="order_id" property="orderId" />
        <result column="order_status" property="orderStatus" />
        <result column="logistics_msg" property="logisticsMsg" />
        <result column="logistics_address" property="logisticsAddress" />
        <result column="driver_id" property="driverId" />
        <result column="plate_number" property="plateNumber" />
    </resultMap>

    <!--gps运踪查询-->
    <resultMap id="GPSResultMap" type="com.zhkj.lc.order.model.entity.OrdOrder">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="plateNumber"    column="plate_number"    />
        <result property="type"    column="type"    />
        <result property="status"    column="status"    />
        <collection property="ordOrderLogistics" column="order_id" select="com.zhkj.lc.order.mapper.OrdOrderLogisticsMapper.selectOrderLogisticsList"/>
    </resultMap>

    <resultMap id="ResultMapForWXpublic" type="com.zhkj.lc.order.dto.CommonGoodsWxSelect">
        <result column="morderId" property="morderId"/>
        <result column="status" property="status"/>
        <result column="pickGoodsPlace" property="pickGoodsPlace"/>
        <result column="sendGoodsPlace" property="sendGoodsPlace"/>
        <result column="receiptCode" property="receiptCode"/>
        <collection property="arrivalAdds" column="morderId" select="com.zhkj.lc.order.mapper.OrdPickupArrivalAddMapper.selectArrivalByOrderId"/>
        <collection property="pickupAdds" column="morderId" select="com.zhkj.lc.order.mapper.OrdPickupArrivalAddMapper.selectPickupByOrderId"/>
    </resultMap>

    <!--判断签收码是否正确-->
    <select id="hasRecCode" resultType="java.lang.Integer">
     select 1 from ord_order where order_id=#{orderId} and receipt_code=#{receiptCode} limit 1;
    </select>

    <select id="hasRecCodeByAdd" resultType="java.lang.Integer">
        select 1 from ord_pickup_arrival_add where order_id = #{orderId} and add_type = 1  and receipt_code = #{receiptCode} and sort = #{sort}
    </select>

    <select id="getOrderId" statementType="CALLABLE" resultType="map">
        {call generate_orderNo(
               #{prefix,mode=IN,jdbcType=VARCHAR},
               #{orderId,mode=OUT,jdbcType=VARCHAR})}
    </select>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        select id, order_id,upstream_id, type, status, class_date, send_truck_date, salesman, scheduleman, carrier, class_order, customer_id, product_name, size, weight, container_no, seal_number, container_type, container_num, if_add_to_yfbill,
        pickup_con_place,pickup_con_detailplace, return_con_place, return_con_detailplace, consignor, consignor_phone, pickup_goods_place, pickup_goods_detailplace, pickup_goods_date, consignee, consignee_phone, send_goods_place, send_goods_detailplace, send_goods_date, driver_id, plate_number, is_invoice,
        kilometre, km_yf, rec_price, pay_price, pay_rate, receivables, need_pay, pickcn_fee, parking_fee, settlement, receiver_remark, receipt_code, is_send, remark, del_flag, create_by, create_time, update_by, update_time, tenant_id, upstream_is_zqzh,upstream_zqzh_class_order,
        upstream_remark, upstream_report_fee, upstream_report_remark, upstream_return_fee, upstream_yc_day, upstream_yc_price,need_pay_status from ord_order
    </sql>

    <!--查询司机正在运输的订单-->
    <select id="selectOrderByDriverId" resultType="com.zhkj.lc.order.dto.OrderSearch">
        select order_id orderId, status from ord_order
        <where>
            del_flag ='0'
            and status = '7'
            <if test="driverId != null "> and driver_id = #{driverId}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        </where>
    </select>

    <!--外调：查询司机正在进行中的订单-->
    <select id="selectOrderByDriverIdFeign" resultType="com.zhkj.lc.order.dto.OrderSearch">
        select order_id orderId, status from ord_order
        <where>
            del_flag ='0'
            <if test="driverId != null "> and driver_id = #{driverId}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        </where>
    </select>

    <select id="selectProcOrdByDriverIds" resultType="Integer">
        select count(order_id)
        from ord_order
        where status != '11' and del_flag ='0'
        <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        <if test="driverIds != null and driverIds.length > 0 "> and driver_id in
            <foreach collection="driverIds" item="driverId" open="(" separator="," close=")">
                #{driverId}
            </foreach>
        </if>
    </select>

    <select id="selectPlateNumberByProcOrd" resultMap="OrderStatusAndPlateNumber">
        select DISTINCT driver_id, plate_number
        from ord_order
        where status not in ('0','11') and del_flag ='0'
        <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
    </select>

    <!--根据订单id查询车牌号,订单状态-->
    <select id="selectOrderByOrderId" resultMap="OrderStatusAndPlateNumber">
        select id,order_id,upstream_id, status,plate_number,type as type,container_no as "containerNo",class_order AS "classOrder",update_time AS "updateTime" from ord_order
        <where>
            del_flag ='0'
            <if test="orderId != null and orderId != '' "> and order_id = #{orderId}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        </where>
    </select>

    <!--查询所有正在运输的订单的最新的运踪地点-->
    <select id="selectOrder" resultMap="ordOrderLogisticsVo">
        SELECT a.order_id,a.logistics_msg,a.logistics_address,a.driver_id,a.plate_number,a.order_status
        FROM
            (
            SELECT
                ool.order_id,ool.logistics_msg,ool.logistics_address,ool.logistics_time,oo.driver_id,oo.plate_number,ool.order_status
            FROM
                ord_order_logistics ool
                LEFT JOIN ord_order oo ON oo.order_id = ool.order_id
            WHERE
                ool.order_id IN (
                SELECT order_id FROM ord_order
                WHERE
                    del_flag = '0' AND tenant_id = #{tenantId} AND STATUS IN ( '3', '4', '5', '6', '7', '8' )
                )
            ) a,
            (
            SELECT oo.order_id, max( ool.logistics_time ) logistics_time
            FROM
                ord_order_logistics ool
                LEFT JOIN ord_order oo ON oo.order_id = ool.order_id
            WHERE
                ool.order_id IN (
                SELECT order_id FROM ord_order
                WHERE
                    del_flag = '0' AND tenant_id = #{tenantId} AND STATUS IN ( '3', '4', '5', '6', '7', '8' )
                )
            GROUP BY oo.order_id
            ) b
        WHERE
            a.order_id = b.order_id
            AND a.logistics_time = b.logistics_time
    </select>

    <!--根据司机id查询未结束订单-->
    <select id="seleteNotEndOrderByDriverId"  resultMap="BaseResultMap">
        <include refid="Base_Column_List"/>
        where driver_id = #{driverId} and status not in ('11','01','0','02','03')
        and del_flag = '0'
    </select>

    <select id="selectOrderByOrderIdForApp" resultMap="BaseResultMapForApp">
        <include refid="Base_Column_List"/>
        <where>
            <if test="orderId != null  and orderId != '' "> and order_id = #{orderId}</if>
            and del_flag = '0'
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
        </where>
    </select>

    <select id="selectOrderListByPage" resultMap="BaseResultMap">
        <include refid="Base_Column_List"/>
        <where>
            <if test="orderId != null  and orderId != '' "> and order_id = #{orderId}</if>
            <if test="type != null  and type != '' "> and type = #{type}</if>
            <if test="status != null  and status != '' "> and status = #{status}</if>
            <if test="status == null or status == '' "> and status != '0'</if>
            <if test="containerNo != null  and containerNo != '' "> and container_no = #{containerNo}</if>
            <if test="plateNumber != null  and plateNumber != '' "> and plate_number = #{plateNumber}</if>
            <if test="classOrder != null  and classOrder != '' "> and class_order = #{classOrder}</if>
            and del_flag = '0'
            <if test="fromDate != null "> and date_format(send_truck_date,'%Y-%m-%d') &gt;= #{fromDate}</if>
            <if test="toDate != null "> and date_format(send_truck_date,'%Y-%m-%d') &lt;= #{toDate}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
            <if test="createBy != null "> and create_by = #{createBy}</if>
            <if test="plates != null and plates.length > 0">

                and plate_number in
                <foreach item="plate" collection="plates" open="(" separator="," close=")">
                    #{plate}
                </foreach>
            </if>
            <if test="customerIds != null and customerIds.length > 0">
                and customer_id in
                <foreach item="customerId" collection="customerIds" open="(" separator="," close=")">
                    #{customerId}
                </foreach>
            </if>

        </where>
        order by update_time desc
    </select>
    <sql id="Base_Column_Export">
        select
          id, order_id orderId,upstream_id, type, status, class_date classDate, send_truck_date sendTruckDate, salesman, scheduleman, carrier, class_order classOrder,
          customer_id customerId, product_name productName, size, weight, container_no containerNo, container_type containerType, container_num containerNum,
          pickup_con_place pickupConPlace, pickup_con_detailplace pickupConDetailplace, return_con_place returnConPlace, return_con_detailplace returnConDetailplace,
          consignor, consignor_phone consignorPhone, pickup_goods_place pickupGoodsPlace, pickup_goods_detailplace pickupGoodsDetailplace, pickup_goods_date pickupGoodsDate,
          consignee, consignee_phone consigneePhone, send_goods_place sendGoodsPlace, send_goods_detailplace sendGoodsDetailplace, send_goods_date sendGoodsDate,
          driver_id driverId, plate_number plateNumber, is_invoice isInvoice, kilometre,km_yf,
          rec_price recPrice, pay_price payPrice, receivables receivables, need_pay needPay, pickcn_fee pickcnFee, parking_fee parkingFee, settlement,
          receiver_remark receiverRemark, receipt_code receiptCode, is_send isSend,
          remark, del_flag delFlag, create_by createBy, create_time createTime, update_by updateBy, update_time updateTime, tenant_id tenantId from ord_order
    </sql>
    <select id="selectOrderListForExport" resultType="com.zhkj.lc.order.dto.OrdOrderForExport" parameterType="com.zhkj.lc.order.dto.OrderSearch">
        <include refid="Base_Column_Export"/>
        <where>
            <if test="orderId != null  and orderId != '' "> and order_id = #{orderId}</if>
            <if test="type != null  and type != '' "> and type = #{type}</if>
            <if test="status != null  and status != '' "> and status = #{status}</if>
            <if test="status == null "> and status not in  ('0','01','02','03')</if>
            <if test="containerNo != null  and containerNo != '' "> and container_no = #{containerNo}</if>
            <if test="plateNumber != null  and plateNumber != '' "> and plate_number = #{plateNumber}</if>
            and del_flag = 0
            <if test="fromDate != null "> and date_format(send_truck_date,'%Y-%m-%d') &gt;= #{fromDate}</if>
            <if test="toDate != null "> and date_format(send_truck_date,'%Y-%m-%d') &lt;= #{toDate}</if>
            <if test="tenantId != null "> and tenant_id = #{tenantId}</if>
            <if test="plates!=null and plates.length > 0">
                and plate_number in
                <foreach item="plate" collection="plates" open="(" separator="," close=")">
                    #{plate}
                </foreach>
            </if>
            <if test="orderIds != null and orderIds.length > 0">
                and order_id in
                <foreach item="orderId" collection="orderIds" open="(" separator="," close=")">
                    #{orderId}
                </foreach>
            </if>
            <if test="customerIds != null and customerIds.length > 0">
                and customer_id in
                <foreach item="customerId" collection="customerIds" open="(" separator="," close=")">
                    #{customerId}
                </foreach>
            </if>
        </where>
        order by update_time desc
    </select>

    <select id="selectOrderById" resultMap="BaseResultMap">
        <include refid="Base_Column_List"/>
        where order_id = #{orderId} and tenant_id = #{tenantId}
    </select>

    <select id="selectOrderBaseById" resultMap="BaseColumnMap">
        <include refid="Base_Column_List"/>
        where order_id = #{orderId} and tenant_id = #{tenantId}
    </select>
    <!-- 微信公众号端搜索查询 -->
    <select id="selectListForWX" resultMap="ResultMapForWXpublic" parameterType="com.zhkj.lc.order.dto.CommonOrdSearch">
        SELECT
        cg.order_id morderId,
        cg.STATUS status,
        cg.send_goods_place pickGoodsPlace,
        cg.pickup_goods_place sendGoodsPlace,
        cg.receipt_code receiptCode
        FROM
        ord_order cg
        LEFT JOIN ord_order_logistics ol_receipt ON ol_receipt.order_id = cg.order_id
        AND ol_receipt.order_status = '5'
        LEFT JOIN ord_order_logistics ol_send ON ol_send.order_id = cg.order_id
        AND ol_send.order_status = '7'
        LEFT JOIN ord_order_logistics ol_received ON ol_received.order_id = cg.order_id
        AND ol_received.order_status = '9'
        where del_flag = '0'
        <if test="statusArray != null and statusArray.length > 0">/*订单状态*/
            and cg.status in
            <foreach item="status" collection="statusArray" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        <if test="driverReceiptTime != null and driverReceiptTime != ''">/*司机接单时间*/
            AND ol_receipt.logistics_time = #{driverReceiptTime}
        </if>
        <!--<if test="sendGoodsTime != null and sendGoodsTime != ''">/*提货时间*/-->
            <!--AND ol_send.logistics_time = #{sendGoodsTime}-->
        <!--</if>-->
        <!--<if test="receivedTime != null and receivedTime != ''">/*签收时间*/-->
            <!--AND ol_received.logistics_time = #{receivedTime}-->
        <!--</if>-->
        <if test="orderId != null and orderId != ''">/*订单编号*/
            AND cg.order_id= #{orderId}
        </if>
        <if test="pickerPhone != null and pickerPhone != ''">/*收货人手机号*/
            AND cg.order_id in (
            select order_id from ord_pickup_arrival_add where contacts_phone = #{pickerPhone} and add_type = '1'
            <if test="receivedTime != null and receivedTime != ''">
                AND order_id IN (
                SELECT order_id FROM ord_pickup_arrival_add WHERE add_type = '1' AND DATE_FORMAT(success_time, '%Y-%m-%d') = #{receivedTime} GROUP BY order_id)
            </if>
            <if test="sendGoodsTime != null and sendGoodsTime != ''">
                AND order_id IN (
                SELECT order_id FROM ord_pickup_arrival_add WHERE add_type = '0' AND DATE_FORMAT(success_time, '%Y-%m-%d') = #{sendGoodsTime} GROUP BY order_id)
            </if>
            GROUP BY order_id
            )
        </if>
        <if test="shipperPhone != null and shipperPhone != ''">/*fa货人手机号*/
            AND cg.order_id in (
            select order_id from ord_pickup_arrival_add where contacts_phone = #{shipperPhone} and add_type = '0'
            <if test="receivedTime != null and receivedTime != ''">
                AND order_id IN (
                SELECT order_id FROM ord_pickup_arrival_add WHERE add_type = '1' AND DATE_FORMAT(success_time, '%Y-%m-%d') = #{receivedTime} GROUP BY order_id)
            </if>
            <if test="sendGoodsTime != null and sendGoodsTime != ''">
                AND order_id IN (
                SELECT order_id FROM ord_pickup_arrival_add WHERE add_type = '0' AND DATE_FORMAT(success_time, '%Y-%m-%d') = #{sendGoodsTime} GROUP BY order_id)
            </if>
            GROUP BY order_id
            )
        </if>
        <if test="customerId != null and customerId != ''">/*微信公众端唯一标识*/
            AND cg.customer_id = #{customerId}
        </if>
        and cg.tenant_id = #{tenantId}
    </select>

    <select id="selectByOrderIdForWX" resultMap="ResultMapForWXpublic" >
        SELECT
            id,
            order_id morderId,
            STATUS status,
            send_goods_place pickGoodsPlace,
            pickup_goods_place sendGoodsPlace
        FROM
          ord_order
        where del_flag = '0' AND order_id= #{orderId}
          and tenant_id = #{tenantId}
    </select>

    <insert id="insertOrder" parameterType="com.zhkj.lc.order.model.entity.OrdOrder">
        insert into ord_order
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orderId != null  and orderId != ''  ">order_id,</if>
            <if test="upstreamId != null  and upstreamId != '' ">upstream_id,</if>
            <if test="type != null  and type != ''  ">type,</if>
            <if test="status != null  and status != ''  ">status,</if>
            <if test="classDate != null  ">class_date,</if>
            <if test="sendTruckDate != null  ">send_truck_date,</if>
            <if test="salesman != null  and salesman != ''  ">salesman,</if>
            <if test="scheduleman != null  and scheduleman != ''  ">scheduleman,</if>
            <if test="carrier != null  and carrier != ''  ">carrier,</if>
            <if test="classOrder != null  and classOrder != ''  ">class_order,</if>
            <if test="customerId != null  ">customer_id,</if>
            <if test="productName != null  and productName != ''  ">product_name,</if>
            <if test="size != null  and size != ''  ">size,</if>
            <if test="weight != null  and weight != ''  ">weight,</if>
            <if test="containerNo != null  and containerNo != ''  ">container_no,</if>
            <if test="containerType != null  and containerType != ''  ">container_type,</if>
            <if test="containerNum != null  ">container_num,</if>
            <if test="pickupConPlace != null  and pickupConPlace != ''  ">pickup_con_place,</if>
            <if test="pickupConDetailplace != null  and pickupConDetailplace != ''  ">pickup_con_detailplace,</if>
            <if test="returnConPlace != null  and returnConPlace != ''  ">return_con_place,</if>
            <if test="returnConDetailplace != null  and returnConDetailplace != ''  ">return_con_detailplace,</if>
            <if test="consignor != null  and consignor != ''  ">consignor,</if>
            <if test="consignorPhone != null  and consignorPhone != ''  ">consignor_phone,</if>
            <if test="pickupGoodsPlace != null  and pickupGoodsPlace != ''  ">pickup_goods_place,</if>
            <if test="pickupGoodsDetailplace != null  and pickupGoodsDetailplace != ''  ">pickup_goods_detailplace,</if>
            <if test="pickupGoodsDate != null  ">pickup_goods_date,</if>
            <if test="consignee != null  and consignee != ''  ">consignee,</if>
            <if test="consigneePhone != null  and consigneePhone != ''  ">consignee_phone,</if>
            <if test="sendGoodsPlace != null  and sendGoodsPlace != ''  ">send_goods_place,</if>
            <if test="sendGoodsDetailplace != null  and sendGoodsDetailplace != ''  ">send_goods_detailplace,</if>
            <if test="sendGoodsDate != null  ">send_goods_date,</if>
            <if test="driverId != null  ">driver_id,</if>
            <if test="plateNumber != null  and plateNumber != ''  ">plate_number,</if>
            <if test="isInvoice != null  and isInvoice != ''  ">is_invoice,</if>
            <if test="kilometre != null  ">kilometre,</if>
            <if test="kmYf != null  ">km_yf,</if>
            <if test="recPrice != null  ">rec_price,</if>
            <if test="payPrice != null  ">pay_price,</if>
            <if test="payRate != null  ">pay_rate,</if>
            <if test="receivables != null  ">receivables,</if>
            <if test="needPay != null  ">need_pay,</if>
            <if test="pickcnFee != null  ">pickcn_fee,</if>
            <if test="parkingFee != null  ">parking_fee,</if>
            <if test="settlement != null  ">settlement,</if>
            <if test="receiverRemark != null  and receiverRemark != ''  ">receiver_remark,</if>
            <if test="receiptCode != null  and receiptCode != ''  ">receipt_code,</if>
            <if test="upstreamRemark != null  and upstreamRemark != ''  ">upstream_remark,</if>
            <if test="remark != null  and remark != ''  ">remark,</if>
            <if test="delFlag != null  and delFlag != ''  ">del_flag,</if>
            <if test="createBy != null  and createBy != ''  ">create_by,</if>
            create_time,
            <if test="updateBy != null  and updateBy != ''  ">update_by,</if>
            update_time,
            <if test="tenantId != null  ">tenant_id</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="orderId != null  and orderId != ''  ">#{orderId},</if>
            <if test="upstreamId != null  and upstreamId != ''  ">#{upstreamId},</if>
            <if test="type != null  and type != ''  ">#{type},</if>
            <if test="status != null  and status != ''  ">#{status},</if>
            <if test="classDate != null  ">#{classDate},</if>
            <if test="sendTruckDate != null  ">#{sendTruckDate},</if>
            <if test="salesman != null  and salesman != ''  ">#{salesman},</if>
            <if test="scheduleman != null  and scheduleman != ''  ">#{scheduleman},</if>
            <if test="carrier != null  and carrier != ''  ">#{carrier},</if>
            <if test="classOrder != null  and classOrder != ''  ">#{classOrder},</if>
            <if test="customerId != null  ">#{customerId},</if>
            <if test="productName != null  and productName != ''  ">#{productName},</if>
            <if test="size != null  and size != ''  ">#{size},</if>
            <if test="weight != null  and weight != ''  ">#{weight},</if>
            <if test="containerNo != null  and containerNo != ''  ">#{containerNo},</if>
            <if test="containerType != null  and containerType != ''  ">#{containerType},</if>
            <if test="containerNum != null  ">#{containerNum},</if>
            <if test="pickupConPlace != null  and pickupConPlace != ''  ">#{pickupConPlace},</if>
            <if test="pickupConDetailplace != null  and pickupConDetailplace != ''  ">#{pickupConDetailplace},</if>
            <if test="returnConPlace != null  and returnConPlace != ''  ">#{returnConPlace},</if>
            <if test="returnConDetailplace != null  and returnConDetailplace != ''  ">#{returnConDetailplace},</if>
            <if test="consignor != null  and consignor != ''  ">#{consignor},</if>
            <if test="consignorPhone != null  and consignorPhone != ''  ">#{consignorPhone},</if>
            <if test="pickupGoodsPlace != null  and pickupGoodsPlace != ''  ">#{pickupGoodsPlace},</if>
            <if test="pickupGoodsDetailplace != null  and pickupGoodsDetailplace != ''  ">#{pickupGoodsDetailplace},</if>
            <if test="pickupGoodsDate != null  ">#{pickupGoodsDate},</if>
            <if test="consignee != null  and consignee != ''  ">#{consignee},</if>
            <if test="consigneePhone != null  and consigneePhone != ''  ">#{consigneePhone},</if>
            <if test="sendGoodsPlace != null  and sendGoodsPlace != ''  ">#{sendGoodsPlace},</if>
            <if test="sendGoodsDetailplace != null  and sendGoodsDetailplace != ''  ">#{sendGoodsDetailplace},</if>
            <if test="sendGoodsDate != null  ">#{sendGoodsDate},</if>
            <if test="driverId != null  ">#{driverId},</if>
            <if test="plateNumber != null  and plateNumber != ''  ">#{plateNumber},</if>
            <if test="isInvoice != null  and isInvoice != ''  ">#{isInvoice},</if>
            <if test="kilometre != null  ">#{kilometre},</if>
            <if test="kmYf != null  ">#{km_yf},</if>
            <if test="recPrice != null  ">#{recPrice},</if>
            <if test="payPrice != null  ">#{payPrice},</if>
            <if test="payRate != null  ">#{payRate},</if>
            <if test="receivables != null  ">#{receivables},</if>
            <if test="needPay != null  ">#{needPay},</if>
            <if test="pickcnFee != null  ">#{pickcnFee},</if>
            <if test="parkingFee != null  ">#{parkingFee},</if>
            <if test="settlement != null  ">#{settlement},</if>
            <if test="receiverRemark != null  and receiverRemark != ''  ">#{receiverRemark},</if>
            <if test="receiptCode != null  and receiptCode != ''  ">#{receiptCode},</if>
            <if test="upstreamRemark != null  and upstreamRemark != ''  ">#{upstreamRemark},</if>
            <if test="remark != null  and remark != ''  ">#{remark},</if>
            <if test="delFlag != null  and delFlag != ''  ">#{delFlag},</if>
            <if test="createBy != null  and createBy != ''  ">#{createBy},</if>
            sysdate(),
            <if test="updateBy != null  and updateBy != ''  ">#{updateBy},</if>
            sysdate(),
            <if test="tenantId != null  ">#{tenantId}</if>
        </trim>
    </insert>

    <update id="updateOrder" parameterType="com.zhkj.lc.order.model.entity.OrdOrder">
        update ord_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="orderId != null  and orderId != ''  ">order_id = #{orderId},</if>
            <if test="type != null  and type != ''  ">type = #{type},</if>
            <if test="status != null  and status != ''  ">status = #{status},</if>
            <if test="classDate != null  ">class_date = #{classDate},</if>
            <if test="sendTruckDate != null  ">send_truck_date = #{sendTruckDate},</if>
            <if test="salesman != null  and salesman != ''  ">salesman = #{salesman},</if>
            <if test="scheduleman != null  and scheduleman != ''  ">scheduleman = #{scheduleman},</if>
            <if test="carrier != null  and carrier != ''  ">carrier = #{carrier},</if>
            <if test="classOrder != null  and classOrder != ''  ">class_order = #{classOrder},</if>
            <if test="customerId != null  ">customer_id = #{customerId},</if>
            <if test="productName != null  and productName != ''  ">product_name = #{productName},</if>
            <if test="size != null  and size != ''  ">size = #{size},</if>
            <if test="weight != null  and weight != ''  ">weight = #{weight},</if>
            <if test="containerNo != null  and containerNo != ''  ">container_no = #{containerNo},</if>
            <if test="containerType != null  and containerType != ''  ">container_type = #{containerType},</if>
            <if test="containerNum != null  ">container_num = #{containerNum},</if>
            <if test="pickupConPlace != null  and pickupConPlace != ''  ">pickup_con_place = #{pickupConPlace},</if>
            <if test="pickupConDetailplace != null  and pickupConDetailplace != ''  ">pickup_con_detailplace = #{pickupConDetailplace},</if>
            <if test="returnConPlace != null  and returnConPlace != ''  ">return_con_place = #{returnConPlace},</if>
            <if test="returnConDetailplace != null  and returnConDetailplace != ''  ">return_con_detailplace = #{returnConDetailplace},</if>
            <if test="consignor != null  and consignor != ''  ">consignor = #{consignor},</if>
            <if test="consignorPhone != null  and consignorPhone != ''  ">consignor_phone = #{consignorPhone},</if>
            <if test="pickupGoodsPlace != null  and pickupGoodsPlace != ''  ">pickup_goods_place = #{pickupGoodsPlace},</if>
            <if test="pickupGoodsDetailplace != null  and pickupGoodsDetailplace != ''  ">pickup_goods_detailplace = #{pickupGoodsDetailplace},</if>
            <if test="pickupGoodsDate != null  ">pickup_goods_date = #{pickupGoodsDate},</if>
            <if test="consignee != null  and consignee != ''  ">consignee = #{consignee},</if>
            <if test="consigneePhone != null  and consigneePhone != ''  ">consignee_phone = #{consigneePhone},</if>
            <if test="sendGoodsPlace != null  and sendGoodsPlace != ''  ">send_goods_place = #{sendGoodsPlace},</if>
            <if test="sendGoodsDetailplace != null  and sendGoodsDetailplace != ''  ">send_goods_detailplace = #{sendGoodsDetailplace},</if>
            <if test="sendGoodsDate != null  ">send_goods_date = #{sendGoodsDate},</if>
            <if test="driverId != null  ">driver_id = #{driverId},</if>
            <if test="plateNumber != null  and plateNumber != ''  ">plate_number = #{plateNumber},</if>
            <if test="isInvoice != null  and isInvoice != ''  ">is_invoice = #{isInvoice},</if>
            <if test="kilometre != null  ">kilometre = #{kilometre},</if>
            <if test="kmYf != null  ">km_yf = #{kmYf},</if>
            <if test="recPrice != null  ">rec_price = #{recPrice},</if>
            <if test="payPrice != null  ">pay_price = #{payPrice},</if>
            <if test="payRate != null  ">pay_rate = #{payRate},</if>
            <if test="receivables != null  ">receivables = #{receivables},</if>
            <if test="needPay != null  ">need_pay = #{needPay},</if>
            <if test="pickcnFee != null  ">pickcn_fee = #{pickcnFee},</if>
            <if test="parkingFee != null  ">parking_fee = #{parkingFee},</if>
            <if test="settlement != null  ">settlement = #{settlement},</if>
            <if test="receiverRemark != null  and receiverRemark != ''  ">receiver_remark = #{receiverRemark},</if>
            <if test="receiptCode != null  and receiptCode != ''  ">receipt_code = #{receiptCode},</if>
            <if test="isSend != null  and isSend != ''  ">is_send = #{isSend},</if>
            <if test="remark != null  and remark != ''  ">remark = #{remark},</if>
            <if test="delFlag != null  and delFlag != ''  ">del_flag = #{delFlag},</if>
            <if test="updateBy != null  and updateBy != ''  ">update_by = #{updateBy},</if>
            <if test="sealNumber != null  and sealNumber != ''  ">seal_number = #{sealNumber},</if>
            update_time = sysdate()
        </trim>
        where order_id = #{orderId}
        <if test="upstreamId != null">
            and upstream_id = #{upstreamId}
        </if>
    </update>

    <update id="cancelByUpstreamId" parameterType="com.zhkj.lc.order.model.entity.OrdOrder">
        update ord_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="status != null  and status != ''  ">status = #{status},</if>
            <if test="delFlag != null  and delFlag != ''  ">del_flag = #{delFlag},</if>
            <if test="updateBy != null  and updateBy != ''  ">update_by = '箱信通',</if>
            update_time = sysdate()
        </trim>
        where upstream_id = #{upstreamId}
            and tenant_id = #{tenantId}
    </update>

    <update id="deleteOrderByIds">
        update ord_order  set
          del_flag= #{delFlag},
          update_by = #{updateBy},
          update_time = sysdate()
        where tenant_id = #{tenantId}
        and order_id in
        <foreach item="orderId" collection="orderIds" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </update>

    <update id="updateOrderBalanceStatus">
        update ord_order  set
        balance_status = #{balanceStatus},update_time = #{updateTime}
        where
         order_id =  #{orderId}
    </update>

    <!--上游系统订单查询-->
    <select id="selectUpstreamOrder" resultType="com.zhkj.lc.order.model.entity.OrdOrder" resultMap="BaseResultMap">
        <include refid="Base_Column_List"/>
        where 1=1
        <if test="orderId != null and orderId != ''">
            and order_id = #{orderId}
        </if>
        <if test="customerName != null and customerName != ''">
            and customer_id = #{customerName}
        </if>
        <if test="status != null and status != ''">
            and status = #{status}
        </if>
        <if test="tenantId != null ">
            and tenant_id = #{tenantId}
        </if>
        <if test="status == null or status == ''">
            and status in ('01','02','03')
        </if>
        and del_flag = '0'
        order by update_time desc
    </select>
    <select id="selectUpStreamOrderExport" resultType="com.zhkj.lc.order.dto.UpStreamOrder" parameterType="com.zhkj.lc.order.dto.OrderSearch">
        <include refid="Base_Column_Export"/>
        <where>
            <if test="orderIds != null and orderIds.length > 0">
                and order_id in
                <foreach item="orderId" collection="orderIds" open="(" separator="," close=")">
                    #{orderId}
                </foreach>
            </if>
            and del_flag = '0'
            and status in ('01','02','03')
        </where>
        order by update_time desc
    </select>

    <!-- 统计某状态的集装箱订单总数 -->
    <select id="countByOrderStatus" resultType="Integer">
        SELECT COUNT(order_id) truckSum
        FROM ord_order
        where del_flag = '0'
        <if test="status != null and status != ''">
            and status = #{status}
        </if>
        <if test="tenantId != null">
            and tenant_id = #{tenantId}
        </if>
    </select>

<!--七日内订单统计-->
    <select id="countOrderNumber" resultType="java.lang.Integer">
        select ifnull(b.count,0)
        from (
        SELECT curdate() as click_date
        union all
        SELECT date_sub(curdate(), interval 1 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 2 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 3 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 4 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 5 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 6 day) as click_date
        ) a
        left join (
        select date(create_time) as datetime, count(*) as count
        from ord_order
        where status &lt;&gt; '0' and del_flag = '0' and tenant_id = #{tenantId}
        group by date(create_time)
        ) b on a.click_date = b.datetime
        ORDER BY a.click_date
    </select>

    <!--七日内订单营业额-->
    <select id="countMoney" resultType="java.math.BigDecimal">
         select ifnull(b.total_fee,0)
        from
        (
        SELECT curdate() as click_date
        union all
        SELECT date_sub(curdate(), interval 1 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 2 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 3 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 4 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 5 day) as click_date
        union all
        SELECT date_sub(curdate(), interval 6 day) as click_date
        ) a
        left join
				(
					SELECT sum(d.total_fee) as total_fee,d.datetime
					from
					(
					select date(c.datetime) as datetime,IFNULL(c.receivables,0) as receivables,
					 IFNULL(c.pickcn_fee,0) as pickcn_fee,
					 IFNULL(c.parking_fee,0) as parking_fee,
					 c.balance_status,
					 IFNULL((c.receivables+c.pickcn_fee+c.parking_fee + c.exception_fee),0) as total_fee
					from
						(
						select
						date(oo.update_time) as datetime,
						 IFNULL(oo.receivables,0) as receivables,
						 IFNULL(oo.pickcn_fee,0) as pickcn_fee,
						 IFNULL(oo.parking_fee,0) as parking_fee,
						 oo.settlement,
						oo.balance_status,
						IFNULL((select sum(exception_fee) from ord_exception_fee oef where oef.order_id = oo.order_id and oef.del_flag='0'),0) as exception_fee
						from ord_order oo
						LEFT JOIN ord_exception_fee oef on oo.order_id = oef.order_id
						 where oo.del_flag = '0' and oo.balance_status in ('2','3')  and oo.tenant_id = #{tenantId}
						 ) c
					 )d
					 GROUP BY d.datetime
        ) b
				on a.click_date = b.datetime
        ORDER BY a.click_date
    </select>

    <!--查询司机当月订单数-->
    <select id="selectCountByDriver" resultType="Integer">
        select count(oo.id) from ord_order oo
        LEFT JOIN ord_order_logistics ool on ool.order_id = oo.order_id
        where
              oo.del_flag = '0'
          and oo.driver_id = #{driverId}
          and oo.tenant_id = #{tenantId}
          and ool.order_status = '3'/*已接单状态*/
          and DATE_FORMAT(ool.logistics_time,'%Y%m')=DATE_FORMAT(CURDATE(),'%Y%m');
    </select>

    <!--更新集装箱订单字段值(加入应收对账单)-->
    <update id="updateByOrderIds">
        update ord_order
        <trim prefix="SET" suffixOverrides=",">
            is_add_to_bill = '1',
            update_time = sysdate()
        </trim>
        where del_flag = '0' and order_id in
        <foreach item="orderId" collection="orderIds"  open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </update>

    <!--更新集装箱订单字段值(移除应收对账单)-->
    <update id="updateBillByOrderIds">
        update ord_order
            SET is_add_to_bill = '0',
            update_time = sysdate(),
            update_by = #{updateBy}
        where order_id in
        <foreach item="orderId" collection="orderIds"  open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </update>
    <!--更新集装箱订单字段值(应付加入对账单)-->
    <update id="addForYFByOrderIds">
        update ord_order
        <trim prefix="SET" suffixOverrides=",">
            if_add_to_yfbill = '1',
            update_time = sysdate(),
            update_by = #{updateBy}
        </trim>
        where order_id in
        <foreach item="orderId" collection="orderIds"  open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </update>

    <!--更新集装箱订单字段值(应付移除对账单)-->
    <update id="removeForYFByOrderIds">
        update ord_order
        SET if_add_to_yfbill = '0',
        update_time = sysdate(),
        update_by = #{updateBy}
        where order_id in
        <foreach item="orderId" collection="orderIds"  open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </update>
    <!--运踪信息查询使用-->
    <select id="selectForGPSByOrderId" resultMap="GPSResultMap" parameterType="String">
        select id, order_id, status, type, plate_number from ord_order
        where order_id = #{orderId}
    </select>

    <update id="updateOrderByUp" parameterType="com.zhkj.lc.order.dto.OrdOrderDTO">
        UPDATE ord_order
         SET upstream_is_zqzh = #{upstreamIsZqzh},
         upstream_zqzh_class_order = #{upstreamZqzhClassOrder}
          WHERE upstream_id = #{upstreamId}
          and tenant_id = #{tenantId}
          and plate_number = #{plateNumber}
    </update>

    <select id="selectOrderByPlateNumberForGPSSystem" resultType="com.zhkj.lc.order.dto.OrderForGPSSystem">
        select
          oo.order_id as orderId,
          oo.upstream_id ordernum, -- 订单号
          oo.status as transitstate,    -- 订单状态
          oo.type gocome,         -- 去回程
          oo.class_order proxynum,-- 舱位号
          oo.product_name goodname, -- 货品名称
          concat_ws('*', oo.container_type, oo.container_num)as boxtype, -- 箱型*箱量
          CASE oo.type
              WHEN '0' THEN
                  '陆港'
              ELSE
                  concat_ws('/',oo.return_con_place, oo.return_con_detailplace)
              END as destination -- 目的地
        from
          ord_order oo
          left join ord_order_logistics ol on ol.order_id = oo.order_id and ol.order_status = '3'
        where
              oo.plate_number = #{plateNumber}
          and oo.del_flag = '0'
          and status not in ('2','0')
          and oo.upstream_id is not null
        order by ol.logistics_time desc
    </select>

    <select id="selectOrderPhoneByOrderId" resultType="com.zhkj.lc.order.model.entity.OrdOrder">
        select id, order_id as orderId, receipt_code receiptCode, consignor_phone consignorPhone, consignee_phone consigneePhone
        from ord_order
        where order_id = #{orderId} and tenant_id = #{tenantId}
    </select>
</mapper>
